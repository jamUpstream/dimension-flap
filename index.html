<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Dimension Flap</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00ffcc" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-title" content="DimFlap" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Decorative page background glows -->
  <div class="page-bg">
    <div class="bg-glow bg-glow-1"></div>
    <div class="bg-glow bg-glow-2"></div>
  </div>

  <!-- ═══════════════════════════════════════════
       INTRO OVERLAY
  ════════════════════════════════════════════ -->
  <div id="introOverlay" class="intro-overlay">
    <canvas id="introCanvas" class="intro-canvas"></canvas>
    <div class="intro-content">
      <div class="intro-boot-lines" id="introBootLines"></div>
      <div class="intro-logo-wrap" id="introLogoWrap">
        <div class="intro-diamond">◈</div>
        <div class="intro-title-lines">
          <div class="intro-title-line" id="itl1">DIMENSION</div>
          <div class="intro-title-line" id="itl2">FLAP</div>
        </div>
        <div class="intro-diamond">◈</div>
      </div>
      <div class="intro-tagline" id="introTagline">SURVIVE SHIFTING DIMENSIONS</div>
      <div class="intro-skip" id="introSkip">TAP TO SKIP</div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════
       PHONE FRAME
  ════════════════════════════════════════════ -->
  <div class="phone-frame">

    <!-- Top bar -->
    <div class="phone-topbar">
      <span class="phone-title-bar">DIMENSION FLAP</span>
    </div>

    <!-- Game viewport -->
    <div class="game-area" id="gameArea">

      <!-- Canvas -->
      <canvas id="gameCanvas"></canvas>

      <!-- HUD -->
      <div id="hud" class="hud hidden">
        <div class="hud-score" id="scoreDisplay">0</div>
        <div class="hud-dim"   id="dimDisplay">DIM 1</div>
      </div>

      <!-- Dimension transition banner -->
      <div id="dimBanner" class="dim-banner">
        <span id="dimBannerText">DIMENSION 1</span>
      </div>

      <!-- ── START SCREEN ── -->
      <div id="startScreen" class="screen active">
        <div class="screen-content">
          <div class="title-block">
            <span class="title-dim">◈</span>
            <h1 class="title">DIMENSION<br>FLAP</h1>
            <span class="title-dim">◈</span>
          </div>
          <div class="instructions">
            <p><kbd>SPACE</kbd> or <kbd>TAP</kbd> to flap</p>
            <p class="sub">Survive shifting dimensions</p>
          </div>
          <button id="startBtn"       class="btn btn-primary">ENTER VOID</button>
          <button id="leaderboardBtn" class="btn btn-ghost">LEADERBOARD</button>
          <button id="optionsBtn"     class="btn btn-ghost">OPTIONS</button>
        </div>
      </div>

      <!-- ── GAME OVER / SAVE SCORE SCREEN ── -->
      <div id="gameOverScreen" class="screen">
        <div class="screen-content">
          <h2 class="over-title">COLLAPSED</h2>

          <div class="scores-row">
            <div class="score-display">
              <span class="score-label">SCORE</span>
              <span id="finalScore" class="score-value">0</span>
            </div>
            <div class="score-divider"></div>
            <div class="score-display">
              <span class="score-label">BEST</span>
              <span id="bestScore" class="score-value">0</span>
            </div>
          </div>

          <!-- Name entry to save score -->
          <div class="name-entry" id="nameEntry">
            <label class="name-label">ENTER YOUR NAME</label>
            <input id="playerNameInput" class="name-input" type="text"
                   maxlength="16" placeholder="PLAYER" autocomplete="off" spellcheck="false" />
            <button id="saveScoreBtn" class="btn btn-primary">SAVE SCORE</button>
            <div id="saveStatus" class="save-status"></div>
          </div>

          <div class="btn-row">
            <button id="restartBtn" class="btn btn-primary">RETRY</button>
            <button id="goMenuBtn"  class="btn btn-ghost">MENU</button>
          </div>
        </div>
      </div>

      <!-- ── LEADERBOARD SCREEN ── -->
      <div id="leaderboardScreen" class="screen">
        <div class="screen-content leaderboard-content">
          <h2 class="lb-title">◈ TOP PILOTS ◈</h2>
          <div id="lbList" class="lb-list">
            <div class="lb-loading">LOADING...</div>
          </div>
          <button id="lbCloseBtn" class="btn btn-ghost">BACK</button>
        </div>
      </div>


      <!-- ── OPTIONS SCREEN ── -->
      <div id="optionsScreen" class="screen">
        <div class="screen-content">
          <h2 class="lb-title">◈ OPTIONS ◈</h2>

          <div class="options-list">

            <div class="option-row option-row-dimscore">
              <div class="option-label-group">
                <span class="option-label">DIM SCORE</span>
                <span class="option-sublabel">Points to reach next dimension</span>
              </div>
              <div class="dim-score-btns" id="dimScoreBtns">
                <button class="dim-score-btn" data-val="5">5</button>
                <button class="dim-score-btn" data-val="10">10</button>
                <button class="dim-score-btn" data-val="30">30</button>
                <button class="dim-score-btn" data-val="50">50</button>
                <button class="dim-score-btn" data-val="100">100</button>
              </div>
            </div>

            <div class="option-row">
              <span class="option-label">SFX</span>
              <button id="sfxToggle" class="toggle-btn active" aria-pressed="true">
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
                <span class="toggle-state">ON</span>
              </button>
            </div>

            <div class="option-row">
              <span class="option-label">LOW SPEC MODE</span>
              <button id="lowSpecToggle" class="toggle-btn" aria-pressed="false">
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
                <span class="toggle-state">OFF</span>
              </button>
            </div>

            <div class="option-row option-row-hell">
              <div class="option-label-group">
                <span class="option-label hell-label">⛧ HELL MODE</span>
                <span class="option-sublabel">Max difficulty — immediately</span>
              </div>
              <button id="hellToggle" class="toggle-btn toggle-btn-hell" aria-pressed="false">
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
                <span class="toggle-state">OFF</span>
              </button>
            </div>

          </div>

          <p class="option-hint">Low Spec disables glow effects &amp; particles<br>Hell Mode voids leaderboard saves</p>
          <button id="optionsCloseBtn" class="btn btn-ghost">BACK</button>
        </div>
      </div>

    </div><!-- /game-area -->

    <!-- Bottom bar -->
    <div class="phone-bottombar">
      <span class="phone-home-btn"></span>
    </div>

  </div><!-- /phone-frame -->

  <!-- ═══════════════════════════════════════════
       PWA INSTALL PROMPT
  ════════════════════════════════════════════ -->
  <div id="pwaPrompt" class="pwa-prompt hidden" role="dialog" aria-label="Install Dimension Flap">
    <div class="pwa-prompt-inner">
      <img src="icon-192.png" class="pwa-icon" alt="Dimension Flap icon" />
      <div class="pwa-text">
        <div class="pwa-title">INSTALL DIMENSION FLAP</div>
        <div class="pwa-sub">Add to home screen &amp; play offline</div>
      </div>
      <div class="pwa-btns">
        <button id="pwaInstallBtn" class="pwa-btn pwa-btn-yes">INSTALL</button>
        <button id="pwaDismissBtn" class="pwa-btn pwa-btn-no">NOT NOW</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // ── Service Worker registration ──────────────────────────
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    // ── PWA Install Prompt ───────────────────────────────────
    (function initPWA() {
      const prompt = document.getElementById('pwaPrompt');
      const installBtn = document.getElementById('pwaInstallBtn');
      const dismissBtn = document.getElementById('pwaDismissBtn');
      let deferredEvent = null;

      // Don't show if already installed or dismissed before
      if (window.matchMedia('(display-mode: standalone)').matches) return;
      if (localStorage.getItem('pwa_dismissed')) return;

      function showPrompt() {
        prompt.classList.remove('hidden');
        requestAnimationFrame(() => prompt.classList.add('visible'));
      }

      function hidePrompt() {
        prompt.classList.remove('visible');
        setTimeout(() => prompt.classList.add('hidden'), 400);
      }

      // Chrome / Android — beforeinstallprompt fires
      window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredEvent = e;
        // Show after a short delay so intro can finish first
        setTimeout(showPrompt, 3200);
      });

      installBtn.addEventListener('click', async () => {
        hidePrompt();
        if (deferredEvent) {
          deferredEvent.prompt();
          const { outcome } = await deferredEvent.userChoice;
          deferredEvent = null;
          if (outcome === 'dismissed') localStorage.setItem('pwa_dismissed', '1');
        }
      });

      dismissBtn.addEventListener('click', () => {
        hidePrompt();
        localStorage.setItem('pwa_dismissed', '1');
      });

      // iOS Safari — no beforeinstallprompt; show manual instructions
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isInStandalone = window.navigator.standalone;
      if (isIOS && !isInStandalone && !localStorage.getItem('pwa_dismissed')) {
        setTimeout(() => {
          // Swap install button text for iOS manual flow
          installBtn.textContent = 'HOW TO INSTALL';
          installBtn.addEventListener('click', () => {
            hidePrompt();
            alert('Tap the Share button ⬆ at the bottom of Safari, then choose "Add to Home Screen".');
          }, { once: true });
          showPrompt();
        }, 3200);
      }
    })();
  </script>
</body>
</html>
